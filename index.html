<!DOCTYPE html>

<html>
<head>
  <meta charset="UTF-8" />
  <title>Secure Redirect</title>

  <!-- Google Identity Services -->

  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>

  <script>
    // ----------------------
    // CONFIGURATION
    // ----------------------
    const allowedEmails = [
      "mariowagdy2013@gmail.com",
      "teacher2@gmail.com",
      "teacher3@hotmail.com"
    ];

    const fallbackPassword = "123456";

    let formURL = null;

    // ----------------------
    // START AUTH FLOW
    // ----------------------
    function start() {
      const urlParams = new URLSearchParams(window.location.search);
      formURL = urlParams.get("form");

      if (!formURL) {
        document.body.innerHTML = "<h2>No form link provided!</h2>";
        return;
      }

      // Check if a trusted user is stored
      const trusted = localStorage.getItem("trustedTeacher");
      if (trusted && (allowedEmails.includes(trusted) || trusted === "passwordAccess")) {
        window.location.href = formURL;
        return;
      }

      // Initialize Google Sign-In
      google.accounts.id.initialize({
        client_id: "427630977928-151dd7ia0joijtta69bntnbkkp7bp0s9.apps.googleusercontent.com",
        callback: handleCredentialResponse
      });

      // Show Google One Tap
      google.accounts.id.prompt((notification) => {
        if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
          showPasswordPrompt();
        }
      });
    }

    // ----------------------
    // HANDLE GOOGLE RESPONSE
    // ----------------------
    function handleCredentialResponse(response) {
      try {
        const data = jwt_decode(response.credential);
        const userEmail = data.email;

        if (allowedEmails.includes(userEmail)) {
          // Save for future visits
          localStorage.setItem("trustedTeacher", userEmail);
          window.location.href = formURL;
        } else {
          showPasswordPrompt();
        }
      } catch (e) {
        showPasswordPrompt();
      }
    }

    // ----------------------
    // FALLBACK PASSWORD
    // ----------------------
    function showPasswordPrompt() {
      const pwd = prompt("Enter access password:");

      if (pwd === fallbackPassword) {
        // Save flag so password users are trusted
        localStorage.setItem("trustedTeacher", "passwordAccess");
        window.location.href = formURL;
      } else {
        alert("Access Denied");
      }
    }
  </script>

</head>

<body onload="start()">
  <h2 style="text-align:center;">Authenticatingâ€¦</h2>
</body>
</html>
